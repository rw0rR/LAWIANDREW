{% extends "base.html" %}

{% block title %}Yönetim Paneli{% endblock %}

{% block head_scripts %}
    <!-- Admin paneli için Tailwind CSS ve Font Awesome yüklendi -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Ana Discord temasına uyum için varsayılan arka plan */
        body { background-color: #36393f; }
        /* İçerik arka planı, Discord kanal listesi gibi */
        .admin-bg { background-color: #2f3136; color: #dcddde; }

        /* Genel Mesaj Stilleri */
        .info-message {
            padding: 10px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
        }

        /* Sekme İçeriğini Yönetme */
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Modal Stilleri */
        .modal { background-color: rgba(0, 0, 0, 0.8); }
        .modal-content { 
            background-color: #2f3136; 
            border: 1px solid #4f545c;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }

        /* Buton stili: Aktif sekme için */
        .tab-button.active-tab {
            color: #7289da;
            border-bottom-color: #7289da;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="admin-bg p-4 md:p-8 min-h-screen">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-extrabold text-white mb-6">Yönetim Paneli</h1>
            
            <!-- Bilgi Mesajı -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="info-message mb-4 {% if category == 'success' %}bg-green-700{% elif category == 'error' %}bg-red-700{% else %}bg-blue-700{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <!-- SEKMELER (TABS) -->
            <div class="flex border-b border-gray-700 mb-6 overflow-x-auto">
                <button onclick="openTab(event, 'users')" id="defaultOpen" class="tab-button active-tab py-3 px-4 sm:px-6 text-sm font-medium border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-300 transition-colors duration-200 focus:outline-none">
                    <i class="fas fa-users mr-2"></i> Kullanıcı Yönetimi
                </button>
                <button onclick="openTab(event, 'rooms')" class="tab-button py-3 px-4 sm:px-6 text-sm font-medium border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-300 transition-colors duration-200 focus:outline-none">
                    <i class="fas fa-comments mr-2"></i> Oda Yönetimi
                </button>
                <button onclick="openTab(event, 'news')" class="tab-button py-3 px-4 sm:px-6 text-sm font-medium border-b-2 border-transparent hover:border-indigo-400 hover:text-indigo-300 transition-colors duration-200 focus:outline-none">
                    <i class="fas fa-newspaper mr-2"></i> Haber Yönetimi
                </button>
            </div>

            <!-- KULLANICI YÖNETİMİ İÇERİĞİ -->
            <div id="users" class="tab-content active">
                <h2 class="text-2xl font-semibold mb-4 text-white">Sistemdeki Tüm Kullanıcılar ({{ users | length }})</h2>
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Kullanıcı Adı
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider hidden sm:table-cell">
                                    Admin mi?
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    İşlemler
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700">
                            {% for username, user_data in users.items() %}
                            <tr class="hover:bg-gray-700 transition duration-150 ease-in-out">
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-white">
                                    {{ username }}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-300 hidden sm:table-cell">
                                    {% if user_data.is_admin %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-800 text-red-100">
                                            Evet
                                        </span>
                                    {% else %}
                                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-800 text-green-100">
                                            Hayır
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex flex-col space-y-2 sm:flex-row sm:space-x-3 sm:space-y-0">
                                        <!-- Kullanıcı Silme -->
                                        <a href="#" 
                                           class="delete-trigger text-red-400 hover:text-red-300 transition" 
                                           data-url="{{ url_for('delete_user', username=username) }}"
                                           data-message="'{{ username }}' adlı kullanıcıyı kalıcı olarak silmek istediğinizden emin misiniz?">
                                            <i class="fas fa-trash-alt"></i> Sil
                                        </a>
                                        
                                        <!-- Admin Yetkisi Ver/Al -->
                                        {% if not user_data.is_admin %}
                                            <a href="{{ url_for('toggle_admin', username=username, make_admin=True) }}" 
                                               class="text-yellow-400 hover:text-yellow-300 transition">
                                                <i class="fas fa-shield-alt"></i> Admin Yap
                                            </a>
                                        {% elif username != session.username %}
                                            <a href="{{ url_for('toggle_admin', username=username, make_admin=False) }}" 
                                               class="text-gray-400 hover:text-gray-300 transition">
                                                <i class="fas fa-user-shield"></i> Adminliği Kaldır
                                            </a>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- ODA YÖNETİMİ İÇERİĞİ -->
            <div id="rooms" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-white">Sistemdeki Tüm Sohbet Odaları ({{ rooms | length }})</h2>
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Oda Adı
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider hidden sm:table-cell">
                                    Oda Kodu
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider hidden sm:table-cell">
                                    Kullanıcı Sayısı
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    İşlemler
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700">
                            {% for code, room in rooms.items() %}
                            <tr class="hover:bg-gray-700 transition duration-150 ease-in-out">
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-white">
                                    #{{ room.name }}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-300 hidden sm:table-cell">
                                    {{ code }}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-300 hidden sm:table-cell">
                                    {{ room.users | length if room.users else 0 }}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                                    <a href="#" 
                                       class="delete-trigger text-red-400 hover:text-red-300 transition"
                                       data-url="{{ url_for('delete_room', room_code=code) }}"
                                       data-message="'{{ room.name }}' ({{ code }}) adlı odayı ve tüm mesajlarını silmek istediğinizden emin misiniz?">
                                        <i class="fas fa-times-circle"></i> Odayı Kapat
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- HABER YÖNETİMİ İÇERİĞİ -->
            <div id="news" class="tab-content">
                <h2 class="text-2xl font-semibold mb-4 text-white">Haber Yönetimi</h2>
                <a href="{{ url_for('add_news') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 mb-4 transition">
                    <i class="fas fa-plus-circle mr-2"></i> Yeni Haber Ekle
                </a>
                
                <div class="overflow-x-auto rounded-lg shadow-xl">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-700">
                            <tr>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    Başlık
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider hidden sm:table-cell">
                                    ID
                                </th>
                                <th scope="col" class="px-3 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">
                                    İşlemler
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-gray-800 divide-y divide-gray-700">
                            {% for id, article in news.items() %}
                            <tr class="hover:bg-gray-700 transition duration-150 ease-in-out">
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-white">
                                    {{ article.title }}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-300 hidden sm:table-cell">
                                    {{ id }}
                                </td>
                                <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                                    <div class="flex flex-col space-y-2 sm:flex-row sm:space-x-3 sm:space-y-0">
                                        <a href="{{ url_for('edit_news', news_id=id) }}" 
                                           class="text-indigo-400 hover:text-indigo-300 transition">
                                            <i class="fas fa-edit"></i> Düzenle
                                        </a>
                                        <a href="#" 
                                           class="delete-trigger text-red-400 hover:text-red-300 transition"
                                           data-url="{{ url_for('delete_news', news_id=id) }}"
                                           data-message="'{{ article.title }}' başlıklı haberi silmek istediğinizden emin misiniz?">
                                            <i class="fas fa-trash-alt"></i> Sil
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
        </div>
    </div>

    <!-- ONAY MODALI (Custom Alert Yerine) -->
    <div id="confirmation-modal" class="modal fixed inset-0 z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="modal-content admin-bg p-6 rounded-lg shadow-2xl max-w-sm w-11/12 transform transition-all duration-300 scale-95">
            <h3 class="text-xl font-bold mb-4 text-red-400">Onay Gerekiyor</h3>
            <p id="modal-message" class="text-gray-300 mb-6 text-sm"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel" class="px-4 py-2 text-sm font-medium rounded-md text-gray-300 bg-gray-600 hover:bg-gray-500 focus:outline-none transition">
                    İptal
                </button>
                <!-- Onay butonu JavaScript ile dinamik olarak güncellenir -->
                <a id="modal-confirm" href="#" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none transition">
                    Onayla
                </a>
            </div>
        </div>
    </div>

    <script>
        // Sekme Yönetimi Fonksiyonu
        function openTab(evt, tabName) {
            // Tüm sekme içeriklerini gizle
            let tabcontent = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove('active');
            }

            // Tüm sekme butonlarından aktif sınıfını kaldır
            let tablinks = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove('active-tab');
            }

            // Mevcut sekmeyi göster ve butonu aktif yap
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active-tab');
        }

        // Modal'ı gösterme (Transition için)
        function showModal() {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = modal.querySelector('.modal-content');

            modal.classList.remove('hidden');
            // DOM güncellemesini bekleyip opacity ve scale geçişlerini başlat
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modalContent.classList.remove('scale-95');
            }, 10); 
        }

        // Modal'ı gizleme (Transition için)
        function hideModal() {
            const modal = document.getElementById('confirmation-modal');
            const modalContent = modal.querySelector('.modal-content');

            modal.classList.add('opacity-0');
            modalContent.classList.add('scale-95');
            
            // Geçiş bittikten sonra hidden sınıfını ekle
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300); 
        }


        // Sayfa yüklendiğinde varsayılan sekmeyi aç ve Modal olaylarını ayarla
        document.addEventListener("DOMContentLoaded", () => {
            // Varsayılan sekmeyi aç
            document.getElementById("defaultOpen").click();

            // Modal Elementleri
            const modal = document.getElementById('confirmation-modal');
            const modalMessage = document.getElementById('modal-message');
            const modalConfirmButton = document.getElementById('modal-confirm');
            const modalCancelButton = document.getElementById('modal-cancel');

            // Silme tetikleyicilerini dinle
            document.querySelectorAll('.delete-trigger').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.preventDefault(); 
                    
                    const url = button.getAttribute('data-url');
                    const message = button.getAttribute('data-message');
                    
                    modalMessage.textContent = message;
                    modalConfirmButton.href = url; // Onay butonunun hedefini ayarla
                    showModal(); 
                });
            });

            // Modal'ı gizleme
            modalCancelButton.addEventListener('click', hideModal);

            // Modal dışına veya ESC tuşuna basınca gizleme
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    hideModal();
                }
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
                    hideModal();
                }
            });
        });
    </script>
{% endblock %}
